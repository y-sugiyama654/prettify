SELECT p.product_id, p.product_name, DATE_FORMAT(o.order_date, '%Y-%m') AS order_month, SUM(oi.quantity * oi.unit_price) AS total_sales, COUNT(DISTINCT o.order_id) AS total_orders, (SELECT AVG(sub.total) FROM (SELECT SUM(oi2.quantity * oi2.unit_price) AS total FROM orders o2 JOIN order_items oi2 ON o2.order_id = oi2.order_id WHERE o2.customer_id = o.customer_id GROUP BY o2.order_id) sub) AS customer_avg_order_total FROM products p JOIN order_items oi ON p.product_id = oi.product_id JOIN orders o ON oi.order_id = o.order_id WHERE o.order_status = 'completed' AND o.order_date BETWEEN '2024-01-01' AND '2024-12-31' GROUP BY p.product_id, order_month ORDER BY total_sales DESC, order_month;
